// script.js

function expenseTracker() {
    // --- Google API Configuration ---
    const CLIENT_ID = '1066473322934-ah4ib6b0pfvisb5ide4t1gj5s7up6uag.apps.googleusercontent.com';
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    return {
        activeTab: 'info',
        userName: '',
        dailyBudget: 0,
        totalSpent: 0,
        expenses: [],
        categoryTotals: { food: 0, transport: 0, entertainment: 0, daily: 0 },
        userInput: { name: '', budget: null },
        newExpense: { category: '', description: '', amount: null },
        editingExpenseId: null,
        editedExpense: { description: '', amount: null },
        notification: { show: false, message: '', type: 'info' },
        notificationTimeout: null,
        showInstallButton: false,
        deferredPrompt: null,
        mobileCharacterExpanded: false,
        
        // ‚ú® Google API/GIS Áõ∏ÈóúÁãÄÊÖã
        isGapiLoaded: false,
        isGisLoaded: false,
        isSignedIn: false,
        tokenClient: null,

        // ÂàùÂßãÂåñ
        init() {
            this.loadFromStorage();
            this.initPWA();
            this.loadGoogleScripts();
        },

        loadGoogleScripts() {
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.async = true;
            gapiScript.defer = true;
            gapiScript.onload = () => {
                gapi.load('client', () => {
                    gapi.client.init({ discoveryDocs: DISCOVERY_DOCS })
                        .then(() => {
                            this.isGapiLoaded = true;
                        });
                });
            };
            document.head.appendChild(gapiScript);

            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.async = true;
            gisScript.defer = true;
            gisScript.onload = () => {
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: this.handleTokenResponse.bind(this),
                    error_callback: this.handleTokenError.bind(this),
                });
                this.isGisLoaded = true;
            };
            document.head.appendChild(gisScript);
        },

        // ÈùúÊÖãË≥áÊñô
        quotes: [
            "ÊâìÂ∑•Ë≥∫Èå¢‰∏çÂÆπÊòìÔºåÊØè‰∏ÄÂàÜÈå¢ÈÉΩË¶ÅÁ≤æÊâìÁ¥∞ÁÆó„ÄÇ", "ÂÅ∂ÁàæËä±ÈªûÈå¢ÁäíË≥ûËá™Â∑±ÔºåÈÄôÊòØÊáâË©≤ÁöÑ„ÄÇ", "ÂóØ...Ëä±Ë≤ªÊúâÈªûË∂ÖÂá∫È†êÊúüÔºåÈúÄË¶ÅÊéßÂà∂‰∏Ä‰∏ã„ÄÇ",
            "ÈÄôÂÄãÊ∂àË≤ªÈÄüÂ∫¶ÊúâÈªûÂø´ÔºåÂæóÈáçÊñ∞Ê™¢Ë¶ñÈ†êÁÆó„ÄÇ", "ÊÉÖÊ≥ÅÈñãÂßã‰∏çÂ¶ôÔºåÈÄôÂÄãÊúàÂèØËÉΩÊúÉÂæàÁ∑ä„ÄÇ", "ÂøÖÈ†àÂÜ∑Èùú‰∏ã‰æÜÔºå‰∏çËÉΩÂÜçÈÄôÊ®£‰∫ÇËä±Èå¢‰∫Ü„ÄÇ",
            "Á≥üÁ≥ïÔºåÁÖßÈÄôÊ®£‰∏ãÂéªÊúÉÂÖ•‰∏çÊï∑Âá∫„ÄÇ", "ÂÆå‰∫ÜÔºåÁîüÊ¥ªË≤ªÈÉΩÂø´‰∏çÂ§†‰∫Ü„ÄÇ", "ÈÄô‰∏ãÁúüÁöÑÈ∫ªÁÖ©‰∫ÜÔºåÈå¢ÂåÖÂø´Ë¶ãÂ∫ï‰∫Ü„ÄÇ", "ÂæπÂ∫ïÁ†¥Áî¢ÔºåÈÄ£Âü∫Êú¨ÁîüÊ¥ªÈÉΩÊàêÂïèÈ°å‰∫Ü„ÄÇ",
            "Â§©ÂïäÔºÅÂ∑≤Á∂ìÂö¥ÈáçË∂ÖÊîØ‰∫ÜÔºÅ", "ÊïëÂëΩÔºÅÈÄôÊ®£‰∏ãÂéªÁúüÁöÑÊúÉÂÆåËõãÔºÅ", "Á∑äÊÄ•ÁãÄÊÖãÔºÅÂøÖÈ†àÁ´ãÂç≥ÂÅúÊ≠¢Ê∂àË≤ªÔºÅ"
        ],
        categoryMeta: {
            food: { icon: 'üçΩÔ∏è', name: 'È§êÈ£≤' },
            transport: { icon: 'üöå', name: '‰∫§ÈÄö' },
            entertainment: { icon: 'üéÆ', name: 'Â®õÊ®Ç' },
            daily: { icon: 'üß¥', name: 'Êó•Áî®ÂìÅ' }
        },

        // Ë°çÁîüÁãÄÊÖã (Getters)
        get remainingAmount() { return Math.max(0, this.dailyBudget - this.totalSpent) },
        get percentage() { return this.dailyBudget > 0 ? Math.round((this.totalSpent / this.dailyBudget) * 100) : 0 },
        get level() { 
            if (this.percentage <= 0) return 0;
            if (this.percentage <= 10) return 1;
            if (this.percentage <= 20) return 2;
            if (this.percentage <= 30) return 3;
            if (this.percentage <= 40) return 4;
            if (this.percentage <= 50) return 5;
            if (this.percentage <= 60) return 6;
            if (this.percentage <= 70) return 7;
            if (this.percentage <= 80) return 8;
            if (this.percentage <= 90) return 9;
            if (this.percentage <= 100) return 10;
            return 11;
        },
        get currentQuote() { 
            const quoteIndex = Math.min(this.level, this.quotes.length - 1);
            return this.quotes[quoteIndex];
        },
        get currentCharacterImage() {
            return Character.getImageByPercentage(this.percentage);
        },
        get characterStatus() {
            return Character.getCharacterStatus(this.percentage);
        },

        // ÊñπÊ≥ï (Actions)
        setUserInfo() {
            if (!this.userInput.name.trim()) {
                this.showNotification('Ë´ãËº∏ÂÖ•ÂßìÂêç', 'error');
                return;
            }
            if (!this.userInput.budget || this.userInput.budget <= 0) {
                this.showNotification('Ë´ãË®≠ÂÆöÊúâÊïàÁöÑÊØèÊó•È†êÁÆóÔºàÂ§ßÊñº 0Ôºâ', 'error');
                return;
            }
            this.userName = this.userInput.name.trim();
            this.dailyBudget = this.userInput.budget;
            this.userInput.name = '';
            this.userInput.budget = null;
            this.saveToStorage();
            this.showNotification('ÂÄã‰∫∫Ë≥áË®äË®≠ÂÆöÊàêÂäüÔºÅ', 'success');
        },

        addExpense() {
            if (!this.newExpense.category) {
                this.showNotification('Ë´ãÈÅ∏ÊìáËä±Ë≤ªÈ°ûÂà•', 'error');
                return;
            }
            if (!this.newExpense.description.trim()) {
                this.showNotification('Ë´ãËº∏ÂÖ•Ëä±Ë≤ªÊèèËø∞', 'error');
                return;
            }
            if (!this.newExpense.amount || this.newExpense.amount <= 0) {
                this.showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°çÔºàÂ§ßÊñº 0Ôºâ', 'error');
                return;
            }
            const expenseToAdd = {
                id: Date.now(),
                ...this.newExpense,
                description: this.newExpense.description.trim(),
                icon: this.categoryMeta[this.newExpense.category].icon,
                categoryName: this.categoryMeta[this.newExpense.category].name,
                timestamp: new Date().toISOString()
            };
            this.expenses.unshift(expenseToAdd);
            this.totalSpent += this.newExpense.amount;
            this.categoryTotals[this.newExpense.category] += this.newExpense.amount;
            this.newExpense.category = '';
            this.newExpense.description = '';
            this.newExpense.amount = null;
            this.saveToStorage();
            this.showNotification('Ëä±Ë≤ªË®òÈåÑÂ∑≤Êñ∞Â¢ûÔºÅ', 'success');
        },

        deleteExpense(id) {
            if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜËä±Ë≤ªË®òÈåÑÂóéÔºü')) {
                const index = this.expenses.findIndex(expense => expense.id === id);
                if (index > -1) {
                    const expenseToDelete = this.expenses[index];
                    this.totalSpent -= expenseToDelete.amount;
                    this.categoryTotals[expenseToDelete.category] -= expenseToDelete.amount;
                    this.expenses.splice(index, 1);
                    this.saveToStorage();
                    this.showNotification('Ëä±Ë≤ªË®òÈåÑÂ∑≤Âà™Èô§', 'success');
                }
            }
        },

        editExpense(expense) {
            this.editingExpenseId = expense.id;
            this.editedExpense.description = expense.description;
            this.editedExpense.amount = expense.amount;
        },

        updateExpense() {
            if (!this.editedExpense.description.trim()) {
                this.showNotification('Ë´ãËº∏ÂÖ•Ëä±Ë≤ªÊèèËø∞', 'error');
                return;
            }
            if (!this.editedExpense.amount || this.editedExpense.amount <= 0) {
                this.showNotification('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÈáëÈ°çÔºàÂ§ßÊñº 0Ôºâ', 'error');
                return;
            }
            const index = this.expenses.findIndex(expense => expense.id === this.editingExpenseId);
            if (index > -1) {
                const originalExpense = this.expenses[index];
                const amountDifference = this.editedExpense.amount - originalExpense.amount;
                
                this.totalSpent += amountDifference;
                this.categoryTotals[originalExpense.category] += amountDifference;

                originalExpense.description = this.editedExpense.description.trim();
                originalExpense.amount = this.editedExpense.amount;
                this.saveToStorage();
                this.showNotification('Ëä±Ë≤ªË®òÈåÑÂ∑≤Êõ¥Êñ∞ÔºÅ', 'success');
            }
            this.cancelEdit();
        },

        cancelEdit() {
            this.editingExpenseId = null;
            this.editedExpense.description = '';
            this.editedExpense.amount = null;
        },

        saveToStorage() {
            const data = {
                userName: this.userName,
                dailyBudget: this.dailyBudget,
                expenses: this.expenses,
                categoryTotals: this.categoryTotals,
                totalSpent: this.totalSpent,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('expenseTracker', JSON.stringify(data));
        },

        loadFromStorage() {
            try {
                const saved = localStorage.getItem('expenseTracker');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.userName = data.userName || '';
                    this.dailyBudget = data.dailyBudget || 0;
                    this.expenses = data.expenses || [];
                    this.categoryTotals = data.categoryTotals || { food: 0, transport: 0, entertainment: 0, daily: 0 };
                    this.totalSpent = data.totalSpent || 0;
                }
            } catch (error) {
                console.error('ËºâÂÖ•Êú¨Âú∞ÂÑ≤Â≠òË≥áÊñôÊôÇÁôºÁîüÈåØË™§:', error);
            }
        },

        clearAllData() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâË≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ')) {
                this.userName = '';
                this.dailyBudget = 0;
                this.expenses = [];
                this.categoryTotals = { food: 0, transport: 0, entertainment: 0, daily: 0 };
                this.totalSpent = 0;
                localStorage.removeItem('expenseTracker');
                this.showNotification('ÊâÄÊúâË≥áÊñôÂ∑≤Ê∏ÖÈô§', 'success');
            }
        },

        showNotification(message, type = 'info', duration = 3000) {
            clearTimeout(this.notificationTimeout);
            this.notification = { show: true, message, type };
            if (duration > 0) {
                this.notificationTimeout = setTimeout(() => {
                    this.notification.show = false;
                }, duration);
            }
        },

        hideNotification() {
            this.notification.show = false;
        },

        // PWA Áõ∏ÈóúÂäüËÉΩ
        initPWA() {
            if (window.pwaInitialized) return;
            window.pwaInitialized = true;

            if ('serviceWorker' in navigator) {
                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (refreshing) return;
                    refreshing = true;
                    window.location.reload();
                });

                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            this.checkForUpdates(registration);
                        })
                        .catch(registrationError => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }
            this.setupInstallPrompt();
        },

        setupInstallPrompt() {
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                this.showInstallButton = true;
                this.deferredPrompt = deferredPrompt;
            });
            window.addEventListener('appinstalled', (evt) => {
                console.log('PWA Â∑≤ÂÆâË£ù');
                this.showInstallButton = false;
                this.showNotification('ÊáâÁî®Á®ãÂºèÂ∑≤ÊàêÂäüÂÆâË£ùÔºÅ', 'success');
            });
        },

        async installApp() {
            if (this.deferredPrompt) {
                this.deferredPrompt.prompt();
                const { outcome } = await this.deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    this.showNotification('Ê≠£Âú®ÂÆâË£ùÊáâÁî®Á®ãÂºè...', 'info');
                } else {
                    this.showNotification('ÂÆâË£ùÂ∑≤ÂèñÊ∂à', 'info');
                }
                this.deferredPrompt = null;
                this.showInstallButton = false;
            }
        },

        checkForUpdates(registration) {
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        this.showUpdateNotification();
                    }
                });
            });
        },

        showUpdateNotification() {
            if (confirm('ÁôºÁèæÊñ∞ÁâàÊú¨ÔºÅÊòØÂê¶Á´ãÂç≥Êõ¥Êñ∞Ôºü')) {
                this.updateApp();
            }
        },

        updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    if (registration && registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                });
            }
        },

        get isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
        },

        get isOnline() {
            return navigator.onLine;
        },

        // --- Google Sheets Integration (GIS) ---
        handleAuthClick() {
            if (this.tokenClient) {
                this.tokenClient.requestAccessToken({ prompt: 'consent' });
            }
        },

        handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    this.isSignedIn = false;
                    this.showNotification('ÊÇ®Â∑≤ÊàêÂäüÁôªÂá∫', 'success');
                });
            }
        },

        handleTokenResponse(response) {
            if (response && response.access_token) {
                gapi.client.setToken(response);
                this.isSignedIn = true;
                this.showNotification('Google ÁôªÂÖ•ÊàêÂäüÔºÅÊ≠£Âú®Ê∫ñÂÇôÂåØÂá∫...', 'info');
                this.performExport();
            } else {
                console.error('Provided token response was invalid.', response);
            }
        },

        handleTokenError(error) {
            console.error('Google Auth Error:', error);
            if (error && (error.type === 'popup_closed' || error.type === 'popup_failed_to_open')) {
                this.showNotification('ÁôªÂÖ•Ë¶ñÁ™óË¢´ÊÇ®ÁöÑÁÄèË¶ΩÂô®ÊàñÂª£ÂëäÊîîÊà™Âô®Êìã‰∏ã‰∫Ü„ÄÇË´ãÂÖÅË®±Êú¨Á´ôÁöÑÂΩàÂá∫ÂºèË¶ñÁ™óÔºåÊàñÂ∞áÊú¨Á´ôÂä†ÂÖ•ÁôΩÂêçÂñÆÂæåÂÜçË©¶‰∏ÄÊ¨°„ÄÇ', 'error', 0);
            }
        },

        exportToSheet() {
            if (this.isSignedIn) {
                this.performExport();
            } else {
                this.handleAuthClick();
            }
        },

        performExport() {
            if (this.expenses.length === 0) {
                this.showNotification('Ê≤íÊúâË≥áÊñôÂèØ‰ª•ÂåØÂá∫', 'error');
                return;
            }
            this.showNotification('Ê≠£Âú®Âª∫Á´ã Google Sheet ‰∏¶ÂåØÂá∫Ë≥áÊñô...', 'info', 0);

            const spreadsheetTitle = `Ëä±Ë≤ªË®òÈåÑ_${this.userName || '‰ΩøÁî®ËÄÖ'}_${new Date().toISOString().split('T')[0]}`;

            gapi.client.sheets.spreadsheets.create({
                properties: {
                    title: spreadsheetTitle
                }
            }).then((response) => {
                const spreadsheetId = response.result.spreadsheetId;
                const spreadsheetUrl = response.result.spreadsheetUrl;

                const summaryData = [
                    ['Â†±Ë°®ÁîüÊàêÊôÇÈñì', new Date().toLocaleString('zh-TW')],
                    ['‰ΩøÁî®ËÄÖÂêçÁ®±', this.userName],
                    ['ÊØèÊó•È†êÁÆó', this.dailyBudget],
                    ['Á∏ΩËä±Ë≤ª', this.totalSpent],
                    ['Ââ©È§òÈ†êÁÆó', this.remainingAmount],
                    ['È†êÁÆó‰ΩøÁî®Áéá (%)', this.percentage],
                    [],
                    ['ÂàÜÈ°ûÁµ±Ë®à'],
                    ['È§êÈ£≤', this.categoryTotals.food],
                    ['‰∫§ÈÄö', this.categoryTotals.transport],
                    ['Â®õÊ®Ç', this.categoryTotals.entertainment],
                    ['Êó•Áî®ÂìÅ', this.categoryTotals.daily],
                ];

                const expensesHeader = ['Êó•Êúü', 'È°ûÂà•', 'ÊèèËø∞', 'ÈáëÈ°ç'];
                const expensesRows = this.expenses.map(e => [
                    new Date(e.timestamp).toLocaleString('zh-TW'),
                    e.categoryName,
                    e.description,
                    e.amount
                ]);

                const data = [
                    { range: 'A1', values: summaryData },
                    { range: 'A15', values: [expensesHeader, ...expensesRows] }
                ];

                gapi.client.sheets.spreadsheets.values.batchUpdate({
                    spreadsheetId: spreadsheetId,
                    resource: {
                        valueInputOption: 'USER_ENTERED',
                        data: data
                    }
                }).then(() => {
                    this.hideNotification();
                    const message = `Ë≥áÊñôÂåØÂá∫ÊàêÂäüÔºÅÈªûÊìä <a href="${spreadsheetUrl}" target="_blank" class="font-bold underline">ÈÄôË£°</a> Êü•ÁúãÊÇ®ÁöÑ Google Sheet„ÄÇ`;
                    this.showNotification(message, 'success', 0);
                }).catch((err) => {
                    console.error('Error writing to sheet:', err);
                    this.showNotification(`ÂØ´ÂÖ• Google Sheet Â§±Êïó: ${err.result.error.message}`, 'error', 0);
                });

            }).catch((err) => {
                console.error('Error creating spreadsheet:', err);
                this.showNotification(`Âª∫Á´ã Google Sheet Â§±Êïó: ${err.result.error.message}`, 'error', 0);
            });
        },

        // ÂåØÂá∫ CSV Ê†ºÂºè
        exportCSV() {
            if (this.expenses.length === 0) {
                this.showNotification('Ê≤íÊúâË≥áÊñôÂèØ‰ª•ÂåØÂá∫', 'error');
                return;
            }

            const headers = ['Êó•Êúü', 'È°ûÂà•', 'ÊèèËø∞', 'ÈáëÈ°ç'];
            const csvContent = [
                headers.join(','),
                ...this.expenses.map(expense => [
                    new Date(expense.timestamp).toLocaleDateString('zh-TW'),
                    expense.categoryName,
                    `"${expense.description}"`, 
                    expense.amount
                ].join(','))
            ].join('\n');

            const dataBlob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Ëä±Ë≤ªË®òÈåÑ_${this.userName || '‰ΩøÁî®ËÄÖ'}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showNotification('CSV Ê™îÊ°àÂåØÂá∫ÊàêÂäüÔºÅ', 'success');
        }
    };
}